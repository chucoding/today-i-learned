# Spring Cloud Gateway
í”„ë¡ì‹œ ì—­í•  (ì‹œìŠ¤í…œì˜ ë‚´ë¶€ êµ¬ì¡°ëŠ” ìˆ¨ê¸°ê³  ì™¸ë¶€ì˜ ìš”ì²­ì— ëŒ€í•´ì„œ ì ì ˆí•œ í˜•íƒœë¡œ ê°€ê³µí•´ì„œ ì‘ë‹µí•  ìˆ˜ ìˆìŒ)

â€» boot 2.4ë²„ì „ ì´ì „ì—ëŠ” Zuulì´ë¼ëŠ” ê²Œì´íŠ¸ì›¨ì´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆì§€ë§Œ ë¹„ë™ê¸° ì²˜ë¦¬ê°€ ì•ˆë˜ëŠ” ë¬¸ì œê°€ ìˆì–´ì„œ Spring Cloud Gatewayê°€ ë“±ì¥. ìµœì‹  Zuul ë²„ì „ì€ ë¹„ë™ê¸°ë¥¼ ì§€ì›í•˜ì§€ë§Œ ê·¸ë˜ë„ ì—¬ì „íˆ ë‹¤ë¥¸ Spring ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ í˜¸í™˜ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì–´ì„œ ëŒ€ë¶€ë¶„ Spring Cloud Gatewayë¥¼ ì‚¬ìš©


### ì‚¬ìš©ë°©ë²•
application.yml
```yml
spring:
  application:
    name: apigateway-service
  cloud:
    gateway:
      routes:
        - id: first-service
          uri: http://localhost:8081/
          predicates:
            - Path=/first-service/**
        - id: second-service
          uri: http://localhost:8082/
          predicates:
            - Path=/second-service/**
```

â— ì¸í…”ë¦¬ì œì´ì—ì„œ gateway ì¶”ê°€í•˜ëŠ” ê²½ìš° spring-cloud-starter-gateway-mvcë¡œ ë°›ì•„ì§€ë¯€ë¡œ ì£¼ì˜ (mvnëŠ” nettyê°€ ì•„ë‹Œ í†°ìº£ìœ¼ë¡œ ì‹¤í–‰ì´ ëœë‹¤.)


# í•„í„°
### ê¸°ë³¸í•„í„°
#### application.yml íŒŒì¼ ëŒ€ì‹  ìë°” í´ë˜ìŠ¤ë¡œ í•„í„° ë§Œë“¤ê¸°
```java
@Configuration
public class FilterConfig {
    @Bean
    public RouteLocator gatewayRoutes(RouteLocatorBuilder builder) {
        return builder.routes()
                .route(r -> r.path("/first-service/**")
                        .filters(f -> f.addRequestHeader("first-request", "first-request-header")
                                .addResponseHeader("first-response", "first-response-header"))
                        .uri("http://localhost:8081")) // .route ì²´ì´ë‹ ê°€ëŠ¥
                .build();
    }
}
```

#### application.yml íŒŒì¼ë¡œ í•„í„° ë§Œë“¤ê¸°  
â— ìœ„ì˜ ìë°”í´ë˜ìŠ¤ì™€ ê°™ì´ ì‚¬ìš© ëª»í•¨. ì•„ë˜ ì½”ë“œ ì‚¬ìš©ì‹œ ìœ„ì˜ @Configuration, @Bean ì£¼ì„ ì²˜ë¦¬ í›„ ì‚¬ìš©í•˜ê¸°
```yml
routes:
- id: first-service
    uri: http://localhost:8081/
    predicates:
    - Path=/first-service/**
    filters:
    - AddRequestHeader=first-request, first-request-header
    - AddResponseHeader=first-response, first-response-header
```

### ì»¤ìŠ¤í…€ í•„í„°
â—ì»¤ìŠ¤í…€ í•„í„° ì‚¬ìš©ì‹œì—ëŠ” FilterConfigë¥¼ Beanìœ¼ë¡œ ì£¼ì…í•˜ë©´ ì•ˆë¨.
```java
import org.springframework.http.server.reactive.ServerHttpRequest; //ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ ServletRequestê³¼ëŠ” ë‹¤ë¥´ë¯€ë¡œ ì£¼ì˜í•„ìš”. (MVCì•„ë‹˜, Webflux)
import org.springframework.http.server.reactive.ServerHttpResponse;
...

@Component
@Slf4j
public class CustomFilter extends AbstractGatewayFilterFactory<CustomFilter.Config> {
    public CustomFilter() {
        super(Config.class);
    }

    @Override
    public GatewayFilter apply(Config config) {
        // Custom Pre Filter
        return (exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();
            ServerHttpResponse response = exchange.getResponse();

            log.info("Custom PRE filter: request id -> {}", request.getId());

            // Custom Post Filter
            return chain.filter(exchange).then(Mono.fromRunnable(()->{
                log.info("Custom POST filter: response code -> {}", response.getStatusCode()); // ë¹„ë™ê¸° ì²˜ë¦¬í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— Mono ì‚¬ìš©
            }));
        };
    }

    public static class Config {
        // Put the configuration properties
    }
}
```
ë§Œë“  ì»¤ìŠ¤í…€ í•„í„° ì ìš©í•˜ê¸°
```yml
routes:
- id: first-service
    uri: http://localhost:8081/
    predicates:
    - Path=/first-service/**
    filters:
        - CustomFilter   # args ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ëŠ” name: í•„ìš”
```

ğŸ’¡ return (exchange, chain) -> {}; ëŒë‹¤ í‘œí˜„ì‹ í•´ì„
```java
GatewayFilter filter = new OrderedGatewayFilter((exchange, chain) -> { //exchange : request, response ì •ë³´ / chain : filter ì •ë³´
  ...
}, Ordered.LOWEST_PRECEDENCE); // í•„í„°ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ì¡°ì •(ê°€ì¥ ë¨¼ì €, ê°€ì¥ ë‚˜ì¤‘ì— ë“±)
return filter;
```

### Global Filter
ê³µí†µì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” í•„í„°
```yml
default-filters:
  - name: GlobalFilter
    args:
      baseMessage: Spring Cloud Gateway Global Filter
      preLogger: true
      postLogger: true
```
â€» argsëŠ” Filter í´ë˜ìŠ¤ì—ì„œ getConfigë¡œ ì‚¬ìš© ê°€ëŠ¥

# ë¡œë“œë°¸ëŸ°ì„œ
API Gatewayì— ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ ì—°ë™í•˜ë©´ ë¡œë“œë°¸ëŸ°ì„œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ì–´í”Œë¦¬ì¼€ì´ì…˜ ë¶€íŠ¸ì—ì„œ ì•„ë˜ì™€ ê°™ì´ í¬íŠ¸ë²ˆí˜¸ë¥¼ 0ë²ˆ(ëœë¤), ìœ ë ˆì¹´ì— instance-idë¥¼ ì§€ì •í•˜ê³  random.valueë¥¼ ì‚¬ìš©í•œë‹¤.
```yml
server:
  port: 0

spring:
  application:
    name: my-first-service

eureka:
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${spring.application.instance_id:${random.value}}
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka
```

ê°™ì€ê±¸ ì—¬ëŸ¬ê°œ ë„ìš°ê³  ê²Œì´íŠ¸ì›¨ì´ yml íŒŒì¼ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•œë‹¤. (ë¡œë“œë°¸ëŸ°ì„œ í˜•ì‹ì€ ë¼ìš´ë“œë¡œë¹ˆ)

```yml
routes:
  - id: first-service
    uri: lb://MY-FIRST-SERVICE
    predicates:
      - Path=/first-service/**
```

ë§Œì•½ ì–´ë””ì—ì„œ í˜¸ì¶œë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •
```java
public class FirstServiceController {
    Environment env;

    @Autowired
    public FirstServiceController(Environment env) {
        this.env = env;
    }
    
    @GetMapping("/check")
    public String check(HttpServletRequest request) {
        log.info("Server port={}", request.getServerPort());
        return String.format("Hi, there. This is a message from First Service on PORT %s.", env.getProperty("local.server.port"));
    } //request, env ë‘˜ ì¤‘ ì•„ë¬´ê±°ë‚˜ ì‚¬ìš©
}
```