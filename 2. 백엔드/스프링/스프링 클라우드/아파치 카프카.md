# Apache Kafka
Apache Software Foundationì˜ Scalar ì–¸ì–´ë¡œ ëœ ì˜¤í”ˆ ì†ŒìŠ¤ ë©”ì‹œì§€ ë¸Œë¡œì»¤ í”„ë¡œì íŠ¸
- ë§í¬ë“œì¸ì—ì„œ ê°œë°œ => Confluent
- Apple, Netflix, Kakao ë“±ë“± ë§ì€ íšŒì‚¬ì—ì„œ ì‚¬ìš©ì¤‘.
- ëŒ€ìš©ëŸ‰, ì•ˆì •ì„± ì¸¡ë©´ì—ì„œ RabbitMQ ë³´ë‹¤ ìš°ìœ„.
- ì‹¤ì‹œê°„ ì „ì†¡ê°€ëŠ¥ ë° í™•ì¥ì„±ì´ ë†’ìŒ(DB ì¢…ë¥˜ì— ìƒê´€ì—†ì´ ì¹´í”„ì¹´ë¡œ ë¶€í„° ë°›ì•„ì˜¤ë©´ ë¨.)
- Scale-out ê°€ëŠ¥

## Kafka Broker
Kafka Application Server

- 3ëŒ€ ì´ìƒì˜ Broker Cluster êµ¬ì„± ê¶Œì¥
- Zookeeper (ë©”íƒ€ë°ì´í„° ì €ì¥ ë° Controller ì •ë³´ ì €ì¥ ex. Broker ID, Controller ID)
- Broker nê°œ ì¤‘ 1ëŒ€ëŠ” Controller ê¸°ëŠ¥ ìˆ˜í–‰
    - ê° Broker íŒŒí‹°ì…˜ í• ë‹¹
    - Broker ëª¨ë‹ˆí„°ë§

## Kafka ì„¤ì¹˜
https://kafka.apache.org/downloads

```cmd
tar -xvf ë‹¤ìš´ë¡œë“œíŒŒì¼
```

## Kafka ê¸°ë™
### Zookeeper
ê¸°ë³¸ í¬íŠ¸ ë²ˆí˜¸ : 2181
```sh
$KAFKA_HOME/bin/zookeeper-server-start.sh $KAFKA_HOME/config/zookeeper.properties
```
```cmd
.\bin\windows\zookeeper-server-start.bat .\config\zookeeper.properties
```

ğŸ’¡ windowì—ì„œ ê¸°ë™ì‹œ ì£¼ì˜ì‚¬í•­
> ì…ë ¥ ì¤„ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤.
ëª…ë ¹ êµ¬ë¬¸ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.

kafka-server-start.batì‹¤í–‰ì‹œ ê°™ì€ í´ë” ì•ˆì— ìˆëŠ” kafka-run-class.batë¥¼ ì°¸ì¡°í•˜ì—¬ ê°™ì´ ì‹¤í–‰ì‹œí‚¤ëŠ”ë° ì—¬ê¸°ì„œ ë„ˆë¬´ ë§ì€ classpathë¥¼ í˜¸ì¶œí•˜ì—¬ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤. (ìœˆë„ìš° cmdëŠ” ëª…ë ¹ì¤„ì— 8192ê¸€ìê¹Œì§€ ì œí•œ)

ë”°ë¼ì„œ kafka-run-class.batì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •(ëŒ€ëµ 93ë¼ì¸ì¯¤ ìœ„ì¹˜)

before
```cmd
rem Classpath addition for release
for %%i in ("%BASE_DIR%\libs\*") do (
call :concat "%%i"
)
```

after
```cmd
rem Classpath addition for release
call :concat "%BASE_DIR%\libs\*;
```

### Kafka Server
ê¸°ë³¸ í¬íŠ¸ ë²ˆí˜¸ : 9092
```sh
$KAFKA_HOME/bin/kafka-server-start.sh $KAFKA_HOME/config/server.properties
```
```cmd
.\bin\windows\kafka-server-start.bat .\config\server.properties
```

## Kafka Core (Client)
ì¹´í”„ì¹´ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ì»¨ìŠˆë¨¸(java í”„ë¡œê·¸ë¨)ë¡œ ì „ë‹¬í•´ì£¼ëŠ” í´ë¼ì´ì–¸íŠ¸ í”„ë¡œê·¸ë¨

### Topic
ì¹´í”„ì¹´ì—ì„œ ë©”ì‹œì§€ê°€ ì €ì¥ë˜ëŠ” ê³³

Topic ìƒì„±
```bash
$KAFKA_HOME/bin/kafka-topics.sh --create --topic quickstart-events --bootstrap-server localhost:9092 --partitions 1
```
```cmd
.\kafka-topics.bat --create --topic quickstart-e
vents --bootstrap-server localhost:9092 --partitions 1
```
- quickstart-events : í† í”½ì´ë¦„
- localhost:9092 : ì¹´í”„ì¹´ ê¸°ë³¸ì„œë²„
- partitions : ë©€í‹° í´ëŸ¬ìŠ¤í„°ë§ ì„¤ì •
  
Topic ëª©ë¡ í™•ì¸
```bash
$KAFKA_HOME/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
```
```cmd
.\kafka-topics.bat --bootstrap-server localhost:9092 --list
```

Topic ì •ë³´ í™•ì¸
```bash
$KAFKA_HOME/bin/kafka-topics.sh --describe --topic quickstart-events --bootstrap-server localhost:9092
```
```cmd
.\kafka-topics.bat --describe --topic quickstart-events --bootstrap-server localhost:9092
```

### Producer
ë©”ì‹œì§€ ìƒì‚°

```bash
$KAFKA_HOME/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic quickstart-events
```
```cmd
.\kafka-console-producer.bat --broker-list local
host:9092 --topic quickstart-events
```

### Consumer
ë©”ì‹œì§€ ì†Œë¹„

```bash
$KAFKA_HOME/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic quickstart-events --from-beginning
```
```cmd
.\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic quickstart-events --from-beginning
```
- --from-beginning : ì²˜ìŒë¶€í„° ë°›ì•„ê°€ëŠ” ì˜µì…˜

## Kafka Connect
Dataë¥¼ Import/Export ê°€ëŠ¥ (Kafka Connect Source/Kafka Connect Sink)

- ì½”ë“œ ì—†ì´ Configurationìœ¼ë¡œ ë°ì´í„°ë¥¼ ì´ë™
- Standalone mode, Distribution mode ì§€ì›
    - RESTful API ì‚¬ìš© ê°€ëŠ¥ (ì»¤ë„¥í„° ìƒì„±, ì‚­ì œ ë“±)
    - Stream ë˜ëŠ” Batch í˜•íƒœë¡œ ë°ì´í„° ì „ì†¡ ê°€ëŠ¥
    - ì»¤ìŠ¤í…€ Connectorë¥¼ í†µí•œ ë‹¤ì–‘í•œ Plugin ì œê³µ (File, S3, Hive, Mysql, etc ...)

### Kafka Connect ì„¤ì¹˜
```cmd
curl -O http://packages.confluent.io/archive/6.1/confluent-community-6.1.0.tar.gz
```

### Kafka Connect ì‹¤í–‰
â— zookiperì™€ kafka-serverê°€ ë¨¼ì € ê¸°ë™ë˜ì–´ ìˆì–´ì•¼ ì‹¤í–‰ëœë‹¤.

```cmd
.\bin\Windows\connect-distributed.bat .\etc\kafka\connect-distributed.properties
```
â— Classpath is empty. Please build the project first e.g. by running 'gradlew jarAll' ì˜¤ë¥˜
>.\bin\windows\kafka-run-class.bat íŒŒì¼ì—ì„œ rem Classpath addition for core ë¶€ë¶„ì„ ì°¾ì•„ì„œ, ê·¸ ìœ„ì— ë‹¤ìŒ ì½”ë“œ ì‚½ì…
```bat
rem classpath addition for LSB style path
if exist %BASE_DIR%\share\java\kafka\* (
    call:concat %BASE_DIR%\share\java\kafka\*
)
```

### Topic ëª©ë¡ í™•ì¸
Kafka Connect ì‹¤í–‰í•˜ê³  ë‚˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ 3ê°œì˜ í† í”½ì´ ìƒì„±ë˜ì–´ ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ.
```
connect-configs
connect-offsets
connect-status
```

### JDBC Connector ì„¤ì¹˜
1. JdbcSourceConnector zip íŒŒì¼ ë‹¤ìš´ë¡œë“œ
https://www.confluent.io/hub/confluentinc/kafka-connect-jdbc

2. etc/kafka/connect-distributed.properties íŒŒì¼ ë§ˆì§€ë§‰ì— ì•„ë˜ plugin ì •ë³´ ì¶”ê°€
```properties
plugin.path=\C:\\Users\\hssuh\\DISK\\spring-cloud\\kafka\\confluentinc-kafka-connect-jdbc-10.0.2\\lib
```

3. JdbcSourceConnectorì—ì„œ MariaDB ì‚¬ìš©í•˜ê¸° ìœ„í•´ mariadb ë“œë¼ì´ë²„ ë³µì‚¬
- ${USER.HOME}\.m2 í´ë”ì—ì„œ mariadb-java-client-2.7.1.jar íŒŒì¼ì„ ./share/java/kafka/ í•˜ìœ„ì— ë³µì‚¬


### Kafka Connect Source
ì¹´í”„ì¹´ë¡œ ë°ì´í„° ì „ë‹¬í•´ì£¼ëŠ” ì—­í• 

MariaDB ì •ë³´ë¥¼ Kafka Source Connectì— ë“±ë¡í•´ë†“ìœ¼ë©´ ì¶”í›„ì— DBì—ì„œ ë³€ê²½ì‚¬í•­ì´ ìƒê¸°ë©´ í† í”½ì— ì €ì¥ë˜ëŠ” í˜•íƒœ
```curl
echo '
{
    "name" : "my-source-connect",
    "config" : {
        "connector.class" : "io.confluent.connect.jdbc.JdbcSourceConnector",
        "connection.url":"jdbc:mysql://localhost:3306/mydb",
        "connection.user":"root",
        "connection.password":"test1357",
        "mode":"incrementing", // ìë™ìœ¼ë¡œ ì¦ê°€ì‹œì¼œì£¼ëŠ” ì˜µì…˜
        "incrementing.column.name":"id",
        "table.whitelist":"users",  // users table ë³€ê²½ì‚¬í•­ ê°ì§€
        "topic.prefix":"my_topic_", // í† í”½ ì´ë¦„ prefix ë“±ë¡
        "tasks.max":"1"
    }
}
' | curl -X POST -d @- http://localhost:8083/connectors --header "content-Type:application/json"
```

### Kafka Connect Sink
ì¹´í”„ì¹´ì˜ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì „ë‹¬í•´ì£¼ëŠ” ì—­í• 

ì•„ë˜ì™€ ê°™ì€ í¬ë©§ìœ¼ë¡œ topicì— ì „ë‹¬
```
{
    "schema":{
        "type":"struct",
        "fields":[
            {"type":"int32","optional":false,"field":"id"},
            {"type":"string","optional":true,"field":"user_id"},{"type":"string","optional":true,"field":"pwd"},{"type":"string","optional":true,"field":"name"},{"type":"int64","optional":true,"name":"org.apache.kafka.connect.data.Timestamp","version":1,"field":"created_at"}
        ],
        "optional":false,
        "name":"users"
    },
    "payload":{
        "id":1,
        "user_id":"users",
        "pwd":"test1111",
        "name":"User name",
        "created_at":1708644247000
    }
}
```