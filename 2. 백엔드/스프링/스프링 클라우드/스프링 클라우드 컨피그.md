# Spring Cloud Config

yaml 파일 우선순위
```
1. bootstrap.yaml
2. application.yaml
3. application-name.yaml
4. application-name-<profile>.yaml
```
### 서버 환경 구성
1. pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server<artifactId>
</dependency>
```

2. application.yaml
```yaml
server:
  port: 8888

spring:
  application:
    name: config-service
  cloud:
    config:
      server:
        git:
          # uri: file://C:\Users\hssuh\DISK\spring-cloud\git-local-repo
          uri: https://github.com/chucoding/spring-cloud-config.git
```
해당 git 파일을 참고해서 데이터를 불러온다.

### 클라이언트 환경 구성
pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

bootstrap.yaml
```yaml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: config-server
```
💡 설정정보를 먼저 가져올 수 있도록 config 서버는 bootstrap.yaml 파일에 지정한다.
💡 config-server로 지정해놓으면 실제 application name으로 지정해놓은 config-server의 application.yaml 파일을 조회한다

### actuator 적용하기
config 커밋 후 refresh API로 클라이언트에 즉시 반영해주는 refresh API 제공

pom.xml
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

application.yaml
```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh, health, beans, httptrace
```

httptrace 추적관리 사용방법 => Application.java
```java
@SpringBootApplication
public class ApigatewayServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApigatewayServiceApplication.class, args);
    }

    @Bean
    public HttpTraceRepository httpTraceRepository() {
        return new InMemoryHttpTraceRepository();
    }

}
```

### Multi-configuration 구성하기
git
```
ecommerce.yaml
ecommerce-dev.yaml
ecommerce-prod.yaml
```

bootstrap.yaml (profiles.active 추가)
```yaml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: ecommerce
  profiles:
    active: dev
```

### git 대신 local 파일 불러오기
```yaml
spring:
  application:
    name: config-service
  profiles:
    active: native
  cloud:
    config:
      server:
        native:
          search-locations: file:///${user.home}/DISK/spring-cloud/native-file-repo
```