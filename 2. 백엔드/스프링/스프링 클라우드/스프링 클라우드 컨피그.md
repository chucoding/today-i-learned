# Spring Cloud Config

yaml íŒŒì¼ ìš°ì„ ìˆœìœ„
```
1. bootstrap.yaml
2. application.yaml
3. application-name.yaml
4. application-name-<profile>.yaml
```
### ì„œë²„ í™˜ê²½ êµ¬ì„±
1. pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server<artifactId>
</dependency>
```

2. application.yaml
```yaml
server:
  port: 8888

spring:
  application:
    name: config-service
  cloud:
    config:
      server:
        git:
          # uri: file://C:\Users\hssuh\DISK\spring-cloud\git-local-repo
          uri: https://github.com/chucoding/spring-cloud-config.git
```
í•´ë‹¹ git íŒŒì¼ì„ ì°¸ê³ í•´ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.

### í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ êµ¬ì„±
pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

bootstrap.yaml
```yaml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: config-server
```
ğŸ’¡ ì„¤ì •ì •ë³´ë¥¼ ë¨¼ì € ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ config ì„œë²„ëŠ” bootstrap.yaml íŒŒì¼ì— ì§€ì •í•œë‹¤.
ğŸ’¡ config-serverë¡œ ì§€ì •í•´ë†“ìœ¼ë©´ ì‹¤ì œ application nameìœ¼ë¡œ ì§€ì •í•´ë†“ì€ config-serverì˜ application.yaml íŒŒì¼ì„ ì¡°íšŒí•œë‹¤

### actuator ì ìš©í•˜ê¸°
config ì»¤ë°‹ í›„ refresh APIë¡œ í´ë¼ì´ì–¸íŠ¸ì— ì¦‰ì‹œ ë°˜ì˜í•´ì£¼ëŠ” refresh API ì œê³µ

pom.xml
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

application.yaml
```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh, health, beans, httptrace
```

httptrace ì¶”ì ê´€ë¦¬ ì‚¬ìš©ë°©ë²• => Application.java
```java
@SpringBootApplication
public class ApigatewayServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApigatewayServiceApplication.class, args);
    }

    @Bean
    public HttpTraceRepository httpTraceRepository() {
        return new InMemoryHttpTraceRepository();
    }

}
```

### Multi-configuration êµ¬ì„±í•˜ê¸°
git
```
ecommerce.yaml
ecommerce-dev.yaml
ecommerce-prod.yaml
```

bootstrap.yaml (profiles.active ì¶”ê°€)
```yaml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: ecommerce
  profiles:
    active: dev
```

### git ëŒ€ì‹  local íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
```yaml
spring:
  application:
    name: config-service
  profiles:
    active: native
  cloud:
    config:
      server:
        native:
          search-locations: file:///${user.home}/DISK/spring-cloud/native-file-repo
```


# ì•”í˜¸í™”, ë³µí˜¸í™”
Spring Cloud Configë¥¼ í†µí•´ git ë˜ëŠ” ë¡œì»¬ ë””ë ‰í† ë¦¬ì—ì„œ íŒŒì¼ì„ ì½ì–´ì˜¬ ë•ŒëŠ” ì•”í˜¸í™”ëœ íŒŒì¼ì„ ì €ì¥í•´ì•¼í•˜ê³  ì‚¬ìš©í•  ë•ŒëŠ” ë³µí˜¸í™” í•´ì•¼í•œë‹¤.

### Symmetric Encryption (Shared)
ëŒ€ì¹­í‚¤(Encryption í‚¤ì™€ Decryption í‚¤ê°€ ê°™ì„ ë•Œ)

### Asymmetric Encryption (RSA Keypair)
ë¹„ëŒ€ì¹­í‚¤ (Encryption í‚¤ì™€ Decryption í‚¤ê°€ ë‹¤ë¥¼ ë•Œ)
- Private Key (ì•”í˜¸í™” í•  ë•Œ)
- Public Key (ë³µí˜¸í™” í•  ë•Œ)

### ëŒ€ì¹­í‚¤ ì•”í˜¸í™” í•˜ëŠ” ë°©ë²•
Spring Config Server - bootstrap.yaml
```yaml
encrypt:
  key: abcdefghijklmnopqrstuvwxyz0123456789
```

ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•´ ë†“ìœ¼ë©´ ì•„ë˜ì™€ ê°™ì´ config ì„œë²„ì—ì„œ API í˜¸ì¶œí•´ì„œ ì•”í˜¸í™” ê°€ëŠ¥
```
http://127.0.0.1:8888/encrypt -D "password"
```

ì¸ì½”ë”©í•œ ì•”í˜¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ cipherë¥¼ ì‹œìš©í•´ì„œ ì„¤ì • íŒŒì¼ì— ì‚½ì…í•  ìˆ˜ ìˆìŒ.  
(cipherë¥¼ ë¶™ì—¬ì•¼ ì‹¤ì œ í˜¸ì¶œí•˜ëŠ” ìª½ì—ì„œ ë””ì½”ë”©ëœ ë°ì´í„°ë¥¼ ì½ì–´ë“¤ì¼ ìˆ˜ ìˆë‹¤.)
  
user-service.yaml
```
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
    username: sa
    password: '{cipher}4cd86d67c695c6327379b3ce4849a12b625061da896e4363afc851d93eca041e'
```

### ë¹„ëŒ€ì¹­í‚¤ ì•”í˜¸í™” í•˜ëŠ” ë°©ë²•
Java Key tool ì„ ì´ìš©í•´ì„œ í‚¤ ê°’ ìƒì„± ê°€ëŠ¥ (jdk8ì¸ ê²½ìš° JCE ë³„ë„ ì„¤ì¹˜ í•„ìš”)
```cmd
keytool -genkeypair -alias apiEncryptionKey -keyalg RSA -dname "CN=chucoding, OU=API Development, O=www.chucoding.com, L=Seoul, C=KR" -keypass "test1234" -keystore apiEncryptionKey.jks -storepass "test1234"
```

ìƒì„±ëœ í‚¤ ì •ë³´ í™•ì¸í•˜ê¸° (privateKey)
```cmd
keytool -list -keystore apiEncryptionKey.jks -v
```

ì¸ì¦ì„œ íŒŒì¼ ì¶”ì¶œí•˜ê¸°
```cmd
keytool -export -alias apiEncryptionKey -keystore apiEncryptionKey.jks -rfc -f
ile trustServer.cer
```

ì¸ì¦ì„œ íŒŒì¼ì„ ë‹¤ì‹œ í‚¤ íŒŒì¼ë¡œ import í•˜ê¸° (publicKey)
```cmd
keytool -import -alias trustServer -file trustServer.cer -keystore publicKey.jks
```

Spring Config Server - bootstrap.yaml
```yaml
encrypt:
  key-store:
    location: file:///${user.home}/DISK/spring-cloud/keystore/apiEncryptionKey.jks
    password: test1234
    alias: apiEncryptionKey
```

user-service.yaml
```
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
    username: sa
    password: '{cipher}AQA3MWmzNIBDUwCeG1aN9LfbAZeCpxgYknHteBgOJDUFUXoXwn1gTCC5h3Hw/hKFMStqgzZii3YADFaEut9YHDnxYqsPRNPFJltKpgJfgyvOZ8qomRciIN7ifsmgJE/QtaobAvOtdA8GA/XO/Xxalj913rxNoD+qGDIBqOn4eNCfhxmKBYD6Xua1FL1rdEswIBmouX8mEyGqS0XOESa8pOLYpNkaMua7goXz5kt2DLpem9psQT+YPa9wm5w2PLxF3Vr0axc8Xa7wGiOF8nRugWqNZLNHI98x3SgoxGHr6NF96I7zri0OsCNICbICXdmx+SFU+O21D1S9z5sNgTuEn4mmjwYRMx0duczlpxaaodpiIRZCWno8yw44pyDlWy6U08E='
```