# Spring Cloud Config

yaml νμΌ μ°μ„ μμ„
```
1. bootstrap.yaml
2. application.yaml
3. application-name.yaml
4. application-name-<profile>.yaml
```
### μ„λ²„ ν™κ²½ κµ¬μ„±
1. pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server<artifactId>
</dependency>
```

2. application.yaml
```yaml
server:
  port: 8888

spring:
  application:
    name: config-service
  cloud:
    config:
      server:
        git:
          # uri: file://C:\Users\hssuh\DISK\spring-cloud\git-local-repo
          uri: https://github.com/chucoding/spring-cloud-config.git
```
ν•΄λ‹Ή git νμΌμ„ μ°Έκ³ ν•΄μ„ λ°μ΄ν„°λ¥Ό λ¶λ¬μ¨λ‹¤.

### ν΄λΌμ΄μ–ΈνΈ ν™κ²½ κµ¬μ„±
pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

bootstrap.yaml
```yaml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: config-server
```
π’΅ μ„¤μ •μ •λ³΄λ¥Ό λ¨Όμ € κ°€μ Έμ¬ μ μλ„λ΅ config μ„λ²„λ” bootstrap.yaml νμΌμ— μ§€μ •ν•λ‹¤.
π’΅ config-serverλ΅ μ§€μ •ν•΄λ†“μΌλ©΄ μ‹¤μ  application nameμΌλ΅ μ§€μ •ν•΄λ†“μ€ config-serverμ application.yaml νμΌμ„ μ΅°νν•λ‹¤

### actuator μ μ©ν•κΈ°
config μ»¤λ°‹ ν›„ refresh APIλ΅ ν΄λΌμ΄μ–ΈνΈμ— μ¦‰μ‹ λ°μν•΄μ£Όλ” refresh API μ κ³µ

pom.xml
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

application.yaml
```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh, health, beans, httptrace
```

httptrace μ¶”μ κ΄€λ¦¬ μ‚¬μ©λ°©λ²• => Application.java
```java
@SpringBootApplication
public class ApigatewayServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApigatewayServiceApplication.class, args);
    }

    @Bean
    public HttpTraceRepository httpTraceRepository() {
        return new InMemoryHttpTraceRepository();
    }

}
```

### Multi-configuration κµ¬μ„±ν•κΈ°
git
```
ecommerce.yaml
ecommerce-dev.yaml
ecommerce-prod.yaml
```

bootstrap.yaml (profiles.active μ¶”κ°€)
```yaml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: ecommerce
  profiles:
    active: dev
```

### git λ€μ‹  local νμΌ λ¶λ¬μ¤κΈ°
```yaml
spring:
  application:
    name: config-service
  profiles:
    active: native
  cloud:
    config:
      server:
        native:
          search-locations: file:///${user.home}/DISK/spring-cloud/native-file-repo
```


# μ•”νΈν™”, λ³µνΈν™”
Spring Cloud Configλ¥Ό ν†µν•΄ git λλ” λ΅μ»¬ λ””λ ‰ν† λ¦¬μ—μ„ νμΌμ„ μ½μ–΄μ¬ λ•λ” μ•”νΈν™”λ νμΌμ„ μ €μ¥ν•΄μ•Όν•κ³  μ‚¬μ©ν•  λ•λ” λ³µνΈν™” ν•΄μ•Όν•λ‹¤.

### Symmetric Encryption (Shared)
λ€μΉ­ν‚¤(Encryption ν‚¤μ™€ Decryption ν‚¤κ°€ κ°™μ„ λ•)

### Asymmetric Encryption (RSA Keypair)
λΉ„λ€μΉ­ν‚¤ (Encryption ν‚¤μ™€ Decryption ν‚¤κ°€ λ‹¤λ¥Ό λ•)
- Private Key (μ•”νΈν™” ν•  λ•)
- Public Key (λ³µνΈν™” ν•  λ•)

### λ€μΉ­ν‚¤ μ•”νΈν™” ν•λ” λ°©λ²•
Spring Config Server - bootstrap.yaml
```yaml
encrypt:
  key: abcdefghijklmnopqrstuvwxyz0123456789
```

λ‹¤μκ³Ό κ°™μ΄ μ„¤μ •ν•΄ λ†“μΌλ©΄ μ•„λμ™€ κ°™μ΄ config μ„λ²„μ—μ„ API νΈμ¶ν•΄μ„ μ•”νΈν™” κ°€λ¥
```
http://127.0.0.1:8888/encrypt -D "password"
```

μΈμ½”λ”©ν• μ•”νΈλ” λ‹¤μκ³Ό κ°™μ΄ cipherλ¥Ό μ‹μ©ν•΄μ„ μ„¤μ • νμΌμ— μ‚½μ…ν•  μ μμ.  
(cipherλ¥Ό λ¶™μ—¬μ•Ό μ‹¤μ  νΈμ¶ν•λ” μ½μ—μ„ λ””μ½”λ”©λ λ°μ΄ν„°λ¥Ό μ½μ–΄λ“¤μΌ μ μλ‹¤.)
  
user-service.yaml
```
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
    username: sa
    password: '{cipher}4cd86d67c695c6327379b3ce4849a12b625061da896e4363afc851d93eca041e'
```

### λΉ„λ€μΉ­ν‚¤ μ•”νΈν™” ν•λ” λ°©λ²•
Java Key tool μ„ μ΄μ©ν•΄μ„ ν‚¤ κ°’ μƒμ„± κ°€λ¥ (jdk8μΈ κ²½μ° JCE λ³„λ„ μ„¤μΉ ν•„μ”)
```cmd
keytool -genkeypair -alias apiEncryptionKey -keyalg RSA -dname "CN=chucoding, OU=API Development, O=www.chucoding.com, L=Seoul, C=KR" -keypass "test1234" -keystore apiEncryptionKey.jks -storepass "test1234"
```