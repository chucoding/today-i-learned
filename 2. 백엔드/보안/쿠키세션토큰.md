# JWT
JSON Web Token  

[HEADER].[PAYLOAD].[SIGNATURE] 구조
- HEADER : 해시 알고리즘, 토큰 타입 정의 (ex. MD5, HS256)
- PAYLOAD : 사용자 데이터(claim)
- SIGNATURE : 토큰의 유효성을 확인하기 위해 사용되는 서명(헤더+페이로드 내용+비밀 키 조합)

### 장점
- 토큰에 필요한 모든 정보가 포함되어 있어 별도의 DB 조회 없이도 정보 검증 가능
- 여러 플랫폼 및 언어에서 일관된 방식으로 사용할 수 있도록 규격이 정의되어 있음

### 셋팅방법
pom.xml
```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>
<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
</dependency>
```
❗ jaxb-api : parsing 하는 곳에서 필수 

application.yaml
```
token:
  expiration_time: 86400000
  secret: user_token
```

CustomFilter.java

### 토큰 생성
```java
String token = Jwts.builder()
    .setSubject(userDetails.getUserId())
    .setExpiration(new Date(System.currentTimeMillis() + Long.parseLong(env.getProperty("token.expiration_time"))))
    .signWith(SignatureAlgorithm.HS512, env.getProperty("token.secret"))
    .compact();

response.addHeader("token", token);
```

### 토큰 검증
```java
@Component
@Slf4j
public class AuthorizationHeaderFilter extends AbstractGatewayFilterFactory<AuthorizationHeaderFilter.Config> {

    Environment env;

    public AuthorizationHeaderFilter(Environment env) {
        super(Config.class);
        this.env = env;
    }

    public static class Config {

    }

    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();

            if (!request.getHeaders().containsKey(HttpHeaders.AUTHORIZATION)) {
                return onError(exchange, "no authorization header", HttpStatus.UNAUTHORIZED);
            }

            String authorizationHeader = request.getHeaders().get(HttpHeaders.AUTHORIZATION).get(0);
            String jwt = authorizationHeader.replace("Bearer", "");

            if(!isJwtValid(jwt)) {
                return onError(exchange, "JWT token is not valid", HttpStatus.UNAUTHORIZED);
            }
            
            return chain.filter(exchange);
        };
    }

    private boolean isJwtValid(String jwt) {
        boolean returnValue = true;

        String subject = null;

        try {
            subject = Jwts.parser().setSigningKey(env.getProperty("token.secret"))
                    .parseClaimsJws(jwt).getBody()
                    .getSubject();
        } catch (Exception ex) {
            returnValue = false;
        }

        if (subject == null || subject.isEmpty()) {
            returnValue = false;
        }

        return returnValue;
    }

    private Mono<Void> onError(ServerWebExchange exchange, String err, HttpStatus httpStatus) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(httpStatus);

        log.error(err);
        return response.setComplete();
    }
}
```


```yml
- id: user-service
  uri: lb://USER-SERVICE
  predicates:
    - Path=/user-service/**
    - Method=GET
  filters:
    - RemoveRequestHeader=Cookie
    - RewritePath=/user-service/(?<segment>.*), /$\{segment}
    - AuthorizationHeaderFilter
```